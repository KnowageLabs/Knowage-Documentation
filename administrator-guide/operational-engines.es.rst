# Motores operativos

## ETL

El knowage permite la carga de datos de los sistemas de origen de acuerdo con una lógica ETL común, así como el monitoreo de los flujos de datos que alimentan continuamente el almacén de datos. Con este fin, Knowage proporciona el ETL **Knowage Talend Engine**.

.. importante::
**Solo Enterprise Edition**

         Please note that in the Enterprise Edition, **KnowageTalendEngine** is shipped with KnowageBD and KnowageSI only. 

KnowageTalendEngine

```

Knowage Talend Engine integrates the open source tool Talent Open Studio (TOS). Talend Open Studio (TOS) is a graphical designer for defining ETL flows. Each designed flow produces a self-alone Java or Perl package. TOS is based on Eclipse and offers a complete environment including test, debug and support for documentation.

The integration between Talend and Knowage is twofold. TOS includes Knowage as a possible execution target for its job, while Knowage implements the standard context interface for communicating with Talend. Jobs can be directly executed from Knowage web interface or possibly scheduled.

Furthermore, the analytical model for monitoring ETL flows can be successfully applied to the analysis of audit and monitoring data generated by a running job. Note that this is not a standard functionality of Knowage suite, but it can be easily realized within a project with Knowage. To create an ETL document, you should perform the following steps:

-  Job design (on Talend);
-  Job deploy;
-  Template building;
-  Analytical document building;
-  Job execution.

In the remainder of the section, we discuss in detail all steps by providing examples.

Job design
~~~~~~~~~~~~

The job is designed directly using Talend.

Designing an ETL job requires to select the proper components from Talend tool palette and connect them to obtain the logic of the ETL flow. Talend will map to appropriate metadata both the structure of any RDBMS and the structure of any possible flow (e.g., TXT, XLS, XML) acting as input or output in the designed ETL.

To design the ETL, several tools are available: from interaction with most RDBMS engines (both proprietary and open source) to support for different file formats; from logging and auditing features to support for several communication and transport protocols (FTP, POP, code, mail); from ETL process control management to data transformation functionalities.

Talend also supports data quality management. Furthermore, it enables the execution of external processes and can interact with other applications, e.g., open source CRM applications, OLAP and reporting tools.

The tMap tool allows the association of sources to targets according to defined rules. The main input is the source table in the data warehouse, while secondary (or lookup) inputs are dimensions to be linked to data. The output (target) is the data structure used for aggregation.

It is also possible to design parametric ETL jobs. We will see how to manage them in the next steps.

Once you have designed the ETL job, you should deploy it on Knowage Server. First of all, configure connections properties to Knowage Server. Select **Preferences** > **Talend** > **Import/export** from within Talend. Then set connection options as described below.

.. _connectionsettings:
.. table:: Connection Settings.
    :widths: auto

    +-----------------------------------+-----------------------------------+
    |    Parameter                      | Value                             |
    +===================================+===================================+
    |    Engine name                    | KnowageTalendEngine               |
    +-----------------------------------+-----------------------------------+
    |    Short description              | Logical name that will be used by |
    |                                   | Talend                            |
    +-----------------------------------+-----------------------------------+
    |    Host                           | Host name or IP address of the    |
    |                                   | connection URL to Knowage         |
    +-----------------------------------+-----------------------------------+
    |    Port                           | Port of the connection URL to     |
    |                                   | Knowage                           |
    +-----------------------------------+-----------------------------------+
    |    Host                           | Host name or IP address of the    |
    |                                   | connection URL to Knowage         |
    +-----------------------------------+-----------------------------------+
    |    Password                       | Password of the user that will    |
    |                                   | perform the deploy                |
    +-----------------------------------+-----------------------------------+ 

Once you have set the connection, you can right click on a job and select **Deploy on Knowage**. This will produce the Java code implementing the ETL and make a copy of the corresponding jar file at ``\\resources\\talend\\RuntimeRepository\\java\\Talend`` project name of Knowage Server. It is possible to deploy multiple jobs at the same time. Exported code is consistent and self-standing. It may include libraries referenced by ETL operators and default values of job parameters, for each context defined in the job. On its side, Knowage manages Talend jobs from an internal repository at ``resources/talend/RuntimeRepository``, under the installation root folder.

Template building
~~~~~~~~~~~~~~~~~~

As with any other Knowage document, you need to define a template for the ETL document that you wish to create. The ETL template has a very simple structure, as shown in the example below:

.. code-block:: xml
         :linenos:
         :caption: ETL template.

          <etl>
          	<job 	project="Foodmart" 
			jobName="sales_by_month_country_product_familiy" 
			context="Default"
          		version="0.1"
          		language="java"
		/>
          </etl>

Where the tag job includes all the following configuration attributes:

-  project is the name of the Talend project
-  jobName is the label assigned to the job in Talends repository.
-  context is the name of the context grouping all job parameters. Typically it is the standard context, denoted with the name **Default**.
-  version is the job version
-  language is the chosen language for code generation. The two possible options are: Java and Perl.

Values in the template must be consistent with those defined in Talend, in order to ensure the proper execution of the ETL document on Knowage Server.

Creating the analytical document
```

Una vez que hemos creado la plantilla, podemos crear un nuevo documento analítico.

Antes de comenzar a crear el documento, se recomienda verificar si el motor está instalado y configurado correctamente. En caso de que el motor no esté visible en la lista Configuración del motor (**Proveedores de datos** > **Gestión del motor**), debe comprobar que la aplicación web está activa invocando la dirección URL `http://myhost:myport/KnowageTalendEngine`.

Ahora puede crear el documento analítico en el servidor, siguiendo el procedimiento estándar. La plantilla para este documento es la que acabamos de crear.
Si el trabajo tiene parámetros, deben asociarse a los controladores analíticos correspondientes, como suele ser habitual. En otras palabras, debe crear un controlador analítico para cada variable de contexto definida en el trabajo de Talend.

Ejecución de trabajos

```

A Talend job can be executed directly from the web interface of Knowage Server and of course from a Talend client.
To execute the job on Knowage, click on the document icon in the document browser, like with any other analytical document. The execution page will show a message to inform that the process was started.

Job scheduling
```

La mayoría de las veces es útil programar la ejecución de trabajos ETL en lugar de ejecutarlos directamente. Puede confiar en la funcionalidad de programación de Knowage para planificar la ejecución de los trabajos de Talend.
Al definir una ejecución programada, puede establecer una opción de notificación que enviará un correo electrónico a un conjunto de destinatarios o una lista de correo una vez que el trabajo haya completado su ejecución. Para habilitar esta opción, marque el indicador **Enviar correo**.

## Procesos externos

El knowage apoya la ejecución de procesos externos a su propia actividad. Al analizar datos, por ejemplo a través de la consola en tiempo real, puede ser útil realizar actividades como enviar correos electrónicos de notificación o realizar acciones sobre los componentes del sistema monitoreado (por ejemplo, procesos comerciales, nodos de red).

Estos productos proporcionan el KnowageProcessEngine, que soporta la ejecución y gestión de procesos externos.

Con el término *proceso* nos referimos a una instrucción Java, por compleja que sea. Los procesos se pueden ejecutar en segundo plano o a través de la interfaz del motor de consola. También es posible programar su inicio y parada.

Para habilitar la gestión de un proceso externo, se requieren los siguientes pasos:

*   Crear una clase Java que defina la lógica de ejecución;
*   Si es necesario, cree una clase Java que defina la lógica del proceso, es decir, qué tareas se supone que debe realizar el proceso (opcional);
*   Cree una plantilla que se asociará al documento knowage;
*   Crear el documento analítico de Knowage CommonJ;

En las siguientes secciones, proporcionamos detalles sobre la creación de clases y plantillas, y la creación de documentos.

Definición de clase

```

First of all, the developer should write a Java class that defines the desired logics for processing start and stop. In particular, this class must extend one of these two classes of the engine:

KnowageWork
    In this case the class to be defined only needs to reimplement the ``run()`` method. This class is the base case: the logic of the external process will be contained in the run() method.

CmdExecWork
    In this case, the class to be defined must implement the method ``execCommand()``. The logic of the external process can be delegated to an external class, which will be invoked by the ``execCommand()`` method. To stop the process, the developer is in charge of checking programmatically whether the process is still running, using the method ``isRunning()``, or not.
    
    .. code-block:: java
        :linenos:
        :caption: Class template
         
        package it.eng.spagobi.job;
        
		import java.util.Iterator;
		import it.eng.spagobi.engines.commonj.process.SpagoBIWork;
        
		public class CommandJob extends SpagoBIWork {
		    @Override
		    public boolean isDaemon() {
		        return true;
            	}
            
            @Override
            public void release() {
                System.out.println("Release!!");
                super.release();
            } 
            
            @Override public void run() { 
                super.run();
                System.out.println("Job started! "); 
                java.util.Map parameters = getSbiParameters();
                for (Iterator iterator = parameters.keySet().iterator(); iterator.hasNext();) {
                    String type = (String) iterator.next();
                    Object o = parameters.get(type);
                    System.out.println("Parameter " + type + " value" + o.toString());
                }
                for(int i = 0; i < 50 && isRunning(); i++) {
                    System.out.println("job is running!"); 
                    try {
                        Thread.sleep(2000);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                System.out.println("Job finished!");
            }
        }
    
    
    Note that the class ``CmdExecWork`` extends ``SpagoBIWork`` by providing additional methods. To better understand the difference between the two options, let us have a look at some code snippets. Here you can see a class implemented as an extension of ``SpagoBIWork``:

   Note also that we only implement the ``run()`` method, embedding the logic of the process in it. Below you can see an example extension of ``CmdExecWork``, called ``CommandJob``:
   
.. code-block:: java
         :linenos:
         :caption: Example extension of CmdExecWork.
         
            package it.eng.spagobi.job;
            import it.eng.spagobi.engines.commonj.process.CmdExecWork;
            import java.io.IOException;
            public class CommandJob extends CmdExecWork{
            public boolean isDaemon() {
            return true;}
            public void release() {
            super.release();}
            public void run() {
            super.run();
            if(isRunning()){
            try {
            execCommand();
            } catch (InterruptedException e) {
            } catch (IOException e) {}}}}

Note that this class implements the ``execCommand()`` method and uses the ``isRunning()`` method. No logic is directly embedded in this class.
Therefore, we also define an external class, called ``ProcessTest``, which contains the actual logic (in our example printing the content of a file):
   
.. code-block:: java
         :linenos:
         :caption: ProcessTest
         
         package it.eng.test;
            import java.io.FileNotFoundException;
            import java.io.FileOutputStream;
            import java.io.PrintStream;
            public class ProcessTest {
            public static void main(String[] args) {
            FileOutputStream file=null;
            try {
            file = new FileOutputStream("C:/file.txt");
            } catch (FileNotFoundException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();}
            PrintStream output = new PrintStream(file);
            while (true){
            output.println("New row");
            output.flush();
            try {
            Thread.currentThread().sleep(5000l);
            } catch (InterruptedException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
            output.close();}}}}
    
Now that classes are ready, we pack them in .jar file containing all classes and their paths. Then we copy the jar file under the resource folder of Knowage at ``RESOURCE_PATH]/commonj/ CommonjRepository/[JAR\\_NAME``. In the next section we will explain how to define the template, based on the class definition chosen above.

Template definition
```

Al igual que con cualquier otro documento de Knowage, necesitamos definir una plantilla para un documento de proceso externo. En el ejemplo siguiente se muestra una plantilla que corresponde a las clases `CommandJob` y `ProcessTest` definido en los ejemplos anteriores. Observemos que esta plantilla corresponde a la opción de implementar una extensión de `CmdExecWork`.

.. code-block:: xml
:linenos:
:caption: Definición de plantilla

          <COMMONJ>
    		<WORK workName='JobTest' className='it.eng.spagobi.job.CommandJob'>
    			<PARAMETERS>                                                       
    				<PARAMETER name='cmd' value='C:/Programmi/Java/jdk1.5.0_16/bin/java'/>
    				<PARAMETER name='classpath' value='C:/resources/commonj/CommonjRepository/JobTest/process.jar'/>
    				<PARAMETER name='cmd_par' value='it.eng.test.ProcessTest'/>
    				<PARAMETER name='sbi_analytical_driver' value='update'/>
    				<PARAMETER name='sbi_analytical_driver' value='level'/>
    			</PARAMETERS>
            </WORK>
          </COMMONJ>

Dónde:

*   `<COMMONJ>` es la etiqueta principal e incluye todo el documento.
*   La etiqueta `<WORK>` especifica el proceso. En particular:

    *   `workName` es el identificador del proceso
    *   `className` contiene el nombre de la clase que implementa el proceso (como se definió anteriormente).
*   La etiqueta `<PARAMETERS>` contiene todos los parámetros. Cada `<PARAMETER>` incluye un parámetro. Algunos de ellos son obligatorios

.. tabla:: Parámetros de la plantilla de documento CommonJ.
:widths: automático

    +-----------------------------------+-----------------------------------+
    |    Parameter                      | Value                             |
    +===================================+===================================+
    |    cmd                            | Specifies the java command that   |
    |                                   | will be launched, with its        |
    |                                   | complete path                     |
    +-----------------------------------+-----------------------------------+
    |    classpath                      | Specifies the classpath           |
    |                                   | containing the jar file. This     |
    |                                   | path will be added to the         |
    |                                   | classpath for the process to run  |
    |                                   | correctly.                        |
    +-----------------------------------+-----------------------------------+
    |    cmd_par                        | Optional. In case it is defined,  |
    |                                   | its value contains the Java class |
    |                                   | that will be launched instead of  |
    |                                   | the job (i.e., the extension of   |
    |                                   | CmdWorkExec or KnowageWork).      |
    +-----------------------------------+-----------------------------------+
    |    sbi_analytical_driver          | Optional and repeatable. Each line|
    |                                   | with this attribute defines an    |
    |                                   | analytical driver that should be  |
    |                                   | associated with the process.      |
    +-----------------------------------+-----------------------------------+

La clase `CmdExecWork` (y sus extensiones) permite la ejecución del comando especificado en la plantilla. En particular, la plantilla anterior produciría el siguiente comando en tiempo de ejecución:

.. code-block:: bash
:linenos:
:caption: Línea de comandos en tiempo de ejecución

         C:/Programmi/Java/jdk1.5.0_16/bin/java 'it.eng.test.ProcessTest' update={val} level={val}
